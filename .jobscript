#!/bin/bash
#PBS -l select=1:ncpus=1:ngpus=1
#PBS -q casper@casper-pbs
#PBS -l gpu_type=gp100
#PBS -j oe

module restore >& /dev/null

export XDG_RUNTIME_DIR=${HOME}/.vnc/xdg-$PBS_JOBID
export XDG_SESSION_ID=
export LD_LIBRARY_PATH=/usr/local/lib64:$LD_LIBRARY_PATH
export PATH=/usr/local/bin/:$PATH
export TVNC_VGL=1

# Create storage and clean up startup script if exists
mkdir -p $XDG_RUNTIME_DIR
rm -f ${HOME}/.vnc/xstartup.turbovnc

XDISP=$(env $desktop_setup vncserver $vnc_opts 2>&1)

if [[ $? != 0 ]]; then
    echo "Error: $XDISP"
    exit
else
    XDISP="vncmgr-display $(echo $XDISP | awk -F '/' '{print $NF}' | cut -d '.' -f1)"
fi

echo $XDISP

XDISP=$(echo $XDISP | cut -d ':' -f2)

exec /bin/bash $my_dir/.vnckill $XDISP
