#!/bin/tcsh -f
#PBS -l select=1:ncpus=1:ngpus=1
#PBS -q casper
#PBS -l gpu_type=gp100
#PBS -j oe

source /etc/csh.cshrc >& /dev/null
module restore >& /dev/null

setenv XDG_RUNTIME_DIR ${HOME}/.vnc/xdg-$PBS_JOBID
setenv XDG_SESSION_ID
setenv LD_LIBRARY_PATH /usr/local/lib64:$LD_LIBRARY_PATH
setenv PATH /usr/local/bin/:$PATH
setenv TVNC_VGL 1

# Create storage and clean up startup script if exists
mkdir -p $XDG_RUNTIME_DIR
rm -f ${HOME}/.vnc/xstartup.turbovnc

set XDISP=`env $desktop_setup vncserver $vnc_opts >& /dev/stdout`

if ( $status != 0 ) then
    echo "Error: $XDISP"
    exit
else
    set XDISP=`echo $XDISP | awk -F '/' '{print $NF}' | cut -d '.' -f1`
endif

echo "vncmgr-display $XDISP"

set XDISP=`echo $XDISP | cut -d ':' -f2`

exec /bin/bash $my_dir/.vnckill $XDISP
